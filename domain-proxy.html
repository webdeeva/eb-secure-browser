<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Loading...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: #050505;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
            background: #050505;
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        #loading.active {
            display: block;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(229, 84, 0, 0.3);
            border-top: 3px solid #e55400;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #domain-info {
            background: #1a1a1a;
            color: #e55400;
            padding: 8px 15px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #333;
        }
        
        .domain-badge {
            background: #e55400;
            color: #fff;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
        }
        
        .actual-url {
            color: #888;
            font-size: 11px;
            flex: 1;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        webview {
            width: 100%;
            height: calc(100vh - 35px);
            border: none;
            background: #fff;
        }
        
        iframe {
            width: 100%;
            height: calc(100vh - 35px);
            border: none;
            background: #fff;
        }
        
        .error-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            display: none;
        }
        
        .error-container.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="domain-info">
        <span class="domain-badge">EB Domain</span>
        <span id="domain-name">Loading...</span>
        <span class="actual-url" id="actual-url"></span>
    </div>
    
    <div id="loading" class="active">
        <div class="spinner"></div>
        <div>Loading domain content...</div>
    </div>
    
    <div id="error-container" class="error-container">
        <h2 style="color: #e55400; margin-bottom: 15px;">Failed to Load Domain Content</h2>
        <p style="color: #ccc; margin-bottom: 20px;">The content for this EB domain couldn't be loaded.</p>
        <button onclick="retry()" style="background: #e55400; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Try Again</button>
    </div>
    
    <webview id="content-view" 
             partition="persist:webview" 
             webpreferences="contextIsolation=false, nodeIntegration=false"
             style="display: none;">
    </webview>
    
    <script>
        const { ipcRenderer } = require('electron');
        
        // Get domain info from URL parameters
        const params = new URLSearchParams(window.location.search);
        const domain = params.get('domain');
        const targetUrl = params.get('url');
        const contentType = params.get('type') || 'url'; // url, ip, or ipfs
        
        // Update domain info display - using textContent is safe from XSS
        document.getElementById('domain-name').textContent = domain;
        document.title = domain;  // title is also safe as it doesn't parse HTML
        
        // Show actual URL in subdued text
        if (contentType === 'url') {
            document.getElementById('actual-url').textContent = `→ ${targetUrl}`;
        } else if (contentType === 'ip') {
            document.getElementById('actual-url').textContent = `→ IP: ${targetUrl}`;
        } else if (contentType === 'ipfs') {
            const hash = targetUrl.replace(/.*\/ipfs\//, '');
            document.getElementById('actual-url').textContent = `→ IPFS: ${hash.substring(0, 12)}...`;
        }
        
        // Load content in webview
        const webview = document.getElementById('content-view');
        
        // SECURITY: Sanitize domain input to prevent XSS
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        const safeDomain = escapeHtml(domain);
        
        webview.addEventListener('dom-ready', () => {
            console.log('Webview DOM ready');
            document.getElementById('loading').classList.remove('active');
            webview.style.display = 'block';
            
            // Inject script to handle navigation within the webview
            // SECURITY: Use JSON.stringify to safely escape the domain value
            webview.executeJavaScript(`
                // Override window.location to maintain the domain masking
                Object.defineProperty(window, 'ebDomain', {
                    value: ${JSON.stringify(domain)},
                    writable: false
                });
                
                // Log for debugging
                console.log('EB Domain proxy active for:', ${JSON.stringify(domain)});
            `);
        });
        
        webview.addEventListener('did-fail-load', (e) => {
            console.error('Failed to load:', e);
            document.getElementById('loading').classList.remove('active');
            document.getElementById('error-container').classList.add('active');
        });
        
        webview.addEventListener('did-start-loading', () => {
            document.getElementById('loading').classList.add('active');
        });
        
        webview.addEventListener('did-stop-loading', () => {
            document.getElementById('loading').classList.remove('active');
        });
        
        // Handle new window requests from the webview
        webview.addEventListener('new-window', (e) => {
            console.log('New window request:', e.url);
            // You could handle this by opening in a new EB browser window
            // or loading in the same webview depending on preference
            e.preventDefault();
            webview.src = e.url;
        });
        
        // Handle navigation within the webview
        webview.addEventListener('will-navigate', (e) => {
            console.log('Navigation within proxy:', e.url);
            // Allow navigation but maintain the EB domain in the parent window
        });
        
        // Security: prevent the webview from accessing parent window
        webview.addEventListener('ipc-message', (event) => {
            // Block any IPC messages from the webview for security
            event.preventDefault();
        });
        
        // Load the target URL
        if (targetUrl) {
            console.log('Loading target URL:', targetUrl);
            webview.src = targetUrl;
        } else {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('error-container').classList.add('active');
        }
        
        function retry() {
            document.getElementById('error-container').classList.remove('active');
            document.getElementById('loading').classList.add('active');
            webview.reload();
        }
        
        // Listen for updates from main process
        ipcRenderer.on('update-domain-content', (event, data) => {
            if (data.url) {
                webview.src = data.url;
            }
        });
    </script>
</body>
</html>